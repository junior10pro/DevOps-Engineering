---
# Playbook de déploiement de l'application DevOps Dashboard
# Ce playbook déploie l'application React sur le serveur web

- name: Deploy DevOps Dashboard Application
  hosts: webservers
  become: yes
  
  vars:
    app_name: devops-dashboard
    app_path: /var/www/{{ app_name }}
    node_version: "18.x"
    nginx_server_name: "_"  # Remplacez par votre domaine si nécessaire
  
  tasks:
    # ===== INSTALLATION DES PRÉREQUIS =====
    
    - name: Mise à jour du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: setup
    
    - name: Installation de curl
      apt:
        name: curl
        state: present
      tags: setup
    
    - name: Ajout du repository NodeSource
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }} | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
      tags: setup
    
    - name: Installation de Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes
      tags: setup
    
    - name: Installation de Nginx
      apt:
        name: nginx
        state: present
      tags: setup
    
    - name: Vérification de l'installation de Node.js
      command: node --version
      register: node_version_output
      changed_when: false
      tags: setup
    
    - name: Affichage de la version Node.js
      debug:
        msg: "Node.js version: {{ node_version_output.stdout }}"
      tags: setup
    
    # ===== DÉPLOIEMENT DE L'APPLICATION =====
    
    - name: Création du répertoire de l'application
      file:
        path: "{{ app_path }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      tags: deploy
    
    - name: Copie des fichiers de l'application
      synchronize:
        src: ../../devops-app/
        dest: "{{ app_path }}/"
        delete: yes
        rsync_opts:
          - "--exclude=node_modules"
          - "--exclude=build"
          - "--exclude=.git"
      tags: deploy
    
    - name: Installation des dépendances npm
      command: npm install
      args:
        chdir: "{{ app_path }}"
      become_user: www-data
      tags: deploy
    
    - name: Build de l'application React
      command: npm run build
      args:
        chdir: "{{ app_path }}"
      become_user: www-data
      tags: deploy
    
    - name: Vérification du dossier build
      stat:
        path: "{{ app_path }}/build"
      register: build_folder
      tags: deploy
    
    - name: Échec si le build n'existe pas
      fail:
        msg: "Le dossier build n'a pas été créé correctement"
      when: not build_folder.stat.exists
      tags: deploy
    
    # ===== CONFIGURATION NGINX =====
    
    - name: Suppression de la configuration Nginx par défaut
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx
      tags: nginx
    
    - name: Configuration Nginx pour l'application
      copy:
        content: |
          server {
              listen 80;
              server_name {{ nginx_server_name }};
              
              root {{ app_path }}/build;
              index index.html;
              
              # Logs
              access_log /var/log/nginx/{{ app_name }}_access.log;
              error_log /var/log/nginx/{{ app_name }}_error.log;
              
              # Gestion des fichiers statiques
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # Cache pour les assets
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # Désactiver le cache pour index.html
              location = /index.html {
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
              }
          }
        dest: /etc/nginx/sites-available/{{ app_name }}
        mode: '0644'
      notify: restart nginx
      tags: nginx
    
    - name: Activation du site Nginx
      file:
        src: /etc/nginx/sites-available/{{ app_name }}
        dest: /etc/nginx/sites-enabled/{{ app_name }}
        state: link
      notify: restart nginx
      tags: nginx
    
    - name: Test de la configuration Nginx
      command: nginx -t
      changed_when: false
      tags: nginx
    
    - name: Démarrage et activation de Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx
  
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
